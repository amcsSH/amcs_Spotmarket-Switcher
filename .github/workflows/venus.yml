name: venus
on:
  workflow_dispatch:
  pull_request:

jobs:
  docker:
    runs-on: ubuntu-latest
    container:
      image: victronenergy/venus-docker
      options: --cpus 1
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Check for dockerenv file
        run: (ls /.dockerenv && echo Found dockerenv) || (echo No dockerenv)
      - name: Install more UNIX tools
        run: |
          if which apt > /dev/null
          then
             apt update
             apt install wget curl
          elif which opkg > /dev/null
          then
             opkg install wget
             opkg install curl
          else
             echo "W: Tests limited because of non-avail of wget and curl"
          fi
      - name: Execute Installation under Venus OS
        run: |
          echo pwd
          pwd
          echo ls
          ls
          echo victron-venus-install.sh
          if ./victron-venus-os-install.sh ; then
             echo "[OK]"
          else
             echo "[FAIL]"
             pwd
             find . |Â head -n 30
             exit 1
          fi
        env:
          NO_REBOOT: 1
          DEBUG: 1
      - name: Execute Run-Script under Venus OS
        run: /data/etc/Spotmarket-Switcher/service/run
        env:
          DEBUG: 1
      - name: Execute Control-Script under Venus OS
        run: |
          if [ -x /data/etc/Spotmarket-Switcher/controller.sh ]; then
            echo "W: Seems ok, just not executing controller.sh because of known to be missing curl binary."
          else
            echo "E: controller.sh was not installed."
            exit 1
          fi
        env:
          DEBUG: 1
