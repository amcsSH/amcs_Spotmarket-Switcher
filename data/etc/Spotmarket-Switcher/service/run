#!/bin/sh

set -e

# Wait for 25 seconds
sleep 25

# The file found at boot time by the OS that amends the crontab to execute the controller.sh script
rc_local_file="/data/rc.local"

code='(crontab -l | grep -Fxq "0 * * * * /data/etc/Spotmarket-Switcher/controller.sh") || (crontab -l; echo "0 * * * * /data/etc/Spotmarket-Switcher/controller.sh") | crontab -'
code2='(crontab -l \| grep -Fxq \"0 * * * * /data/etc/Spotmarket-Switcher/controller.sh\") \|\| (crontab -l; echo \"0 * * * * /data/etc/Spotmarket-Switcher/controller.sh\") \| crontab -'

# Count number of occurences of the code to be executed in the rc.local file
count=$(grep -Fc "$code" "$rc_local_file" )

if [ $count -eq 0 ]; then

    # The rc.local file does not feature the instruction, yet.
    # Add crontab immediately and at system start (only if it doesnt exist)
    echo >> "$rc_local_file"
    echo "$code" >> "$rc_local_file"
    chmod +x "$rc_local_file"
    (crontab -l | grep -Fxq "0 * * * * /data/etc/Spotmarket-Switcher/controller.sh") || (crontab -l; echo "0 * * * * /data/etc/Spotmarket-Switcher/controller.sh") | crontab -

elif [ $count -gt 1 ]; then

    # Removing doublettes to correct for a bug of a older version of this run script
    awk '!seen[$code2]++' $rc_local_file > $rc_local_file.tmp && mv $rc_local_file.tmp $rc_local_file
    chmod +x "$rc_local_file"

fi

# exit with success
exit 0
